<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Lite Log Analyzer</title>
    <style>
        body {
            font-family: sans-serif;
            background: #f4f4f9;
            padding: 20px;
            font-size: 14px;
        }

        .wrap {
            max-width: 900px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .ctrl {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .domain {
            border: 1px solid #ddd;
            margin-bottom: 8px;
            border-radius: 4px;
        }

        .dom-head {
            background: #f9f9f9;
            padding: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            font-weight: bold;
        }

        .dom-head:hover {
            background: #f1f1f1;
        }

        .content {
            display: none;
            padding: 10px;
            border-top: 1px solid #eee;
        }

        .show {
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 5px;
        }

        th {
            text-align: left;
            background: #eee;
            padding: 6px;
        }

        td {
            padding: 6px;
            border-bottom: 1px solid #eee;
        }

        .otb {
            color: #d81b60;
            font-weight: bold;
        }

        .cust {
            color: #7b1fa2;
            font-weight: bold;
        }

        .oplog {
            color: #00796b;
            font-weight: bold;
            background: #e0f2f1;
        }

        .summary {
            margin-bottom: 15px;
            font-size: 12px;
            color: #666;
        }
    </style>
</head>

<body>

    <div class="wrap">
        <h3>Log Execution Summary</h3>
        <div class="ctrl">
            <input type="file" id="f">
            <label>Min Step (sec): <input type="number" id="m" value="0" style="width:50px"></label>
            <button onclick="parse()">Analyze</button>
        </div>
        <div id="out"></div>
    </div>

    <script>
        let data = [];
        function parse() {
            const file = document.getElementById('f').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                const lines = e.target.result.split('\n');
                data = [];
                let curr = null;
                let lastFunc = "";
                let lastTS = null;

                const reTS = /^(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3})/;
                const reDom = /Running transformation for (.+?)\s+\*/;
                const reOTB = /Column OTB Function\s*:\s*(\w+)/;
                const reCus = /CUSTOM FUNCTION\s*-\s*(.+?)\s*-/;
                const reOp = /operation execution time\s*:\s*([\d:]+)/i;

                lines.forEach(l => {
                    const tsM = l.match(reTS);
                    if (!tsM) return;
                    const time = new Date(tsM[1].replace(',', '.'));

                    const dM = l.match(reDom);
                    if (dM) {
                        if (curr) curr.end = time;
                        curr = { n: dM[1].trim(), start: time, s: [] };
                        data.push(curr);
                    }

                    const oM = l.match(reOTB);
                    const cM = l.match(reCus);
                    const opM = l.match(reOp);

                    if (oM) lastFunc = oM[1];
                    if (cM) lastFunc = cM[1];

                    if (curr && (oM || cM || opM)) {
                        let d = 0, t = "", n = lastFunc;
                        if (opM) {
                            const p = opM[1].split(':');
                            d = (p[0] * 3600) + (p[1] * 60) + parseFloat(p[2]);
                            t = "OpLog"; n = "Time: " + lastFunc;
                        } else {
                            d = lastTS ? (time - lastTS) / 1000 : 0;
                            t = oM ? "OTB" : "Custom";
                        }
                        curr.s.push({ n, t, d, ts: tsM[1].split(' ')[1] });
                    }
                    lastTS = time;
                });
                if (curr) curr.end = lastTS;
                render();
            };
            reader.readAsText(file);
        }

        function render() {
            const min = parseFloat(document.getElementById('m').value) || 0;
            const out = document.getElementById('out');
            out.innerHTML = "";
            data.forEach(d => {
                const sec = (d.end - d.start) / 1000;
                const steps = d.s.filter(s => s.d >= min);
                if (min > 0 && steps.length === 0) return;

                const div = document.createElement('div');
                div.className = 'domain';
                div.innerHTML = `
                <div class="dom-head" onclick="this.nextElementSibling.classList.toggle('show')">
                    <span>${d.n}</span> <span>${sec.toFixed(1)}s</span>
                </div>
                <div class="content">
                    <table>
                        <tr><th>Time</th><th>Function</th><th>Duration</th></tr>
                        ${steps.map(s => `<tr>
                            <td>${s.ts}</td>
                            <td class="${s.t.toLowerCase()}">${s.n}</td>
                            <td class="${s.t === 'OpLog' ? 'oplog' : ''}">${s.d.toFixed(2)}s</td>
                        </tr>`).join('')}
                    </table>
                </div>`;
                out.appendChild(div);
            });
        }
    </script>
</body>

</html>